{"version":3,"file":"angular-fire-messaging.js","sources":["../../../src/messaging/base.ts","../../../src/messaging/messaging.ts","../../../src/messaging/messaging.module.ts"],"names":[],"mappings":"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","sourcesContent":["export const proxyPolyfillCompat = {\n  deleteToken: null,\n  getToken: null,\n  onMessage: null,\n  onBackgroundMessage: null,\n  onTokenRefresh: null,\n  requestPermission: null,\n  setBackgroundMessageHandler: null,\n  useServiceWorker: null,\n  usePublicVapidKey: null,\n};\n","import { Inject, Injectable, InjectionToken, NgZone, Optional, PLATFORM_ID } from '@angular/core';\nimport firebase from 'firebase/app';\nimport { concat, EMPTY, Observable, of, throwError, fromEvent } from 'rxjs';\nimport { catchError, defaultIfEmpty, map, mergeMap, observeOn, switchMap, switchMapTo, shareReplay, filter, subscribeOn } from 'rxjs/operators';\nimport {\n  FIREBASE_APP_NAME,\n  FIREBASE_OPTIONS,\n  FirebaseAppConfig,\n  FirebaseOptions,\n  ɵAngularFireSchedulers,\n  ɵfirebaseAppFactory,\n  ɵlazySDKProxy,\n  ɵPromiseProxy,\n  ɵapplyMixins\n} from '@angular/fire';\nimport { isPlatformServer } from '@angular/common';\nimport { proxyPolyfillCompat } from './base';\nimport { ɵfetchInstance } from '@angular/fire';\n\nexport const VAPID_KEY = new InjectionToken<string>('angularfire2.messaging.vapid-key');\nexport const SERVICE_WORKER = new InjectionToken<Promise<ServiceWorkerRegistration>>('angularfire2.messaging.service-worker-registeration');\n\n// SEMVER(7): drop\nconst firebaseLTv8 = parseInt(firebase.SDK_VERSION, 10) < 8;\n\nexport interface AngularFireMessaging extends Omit<ɵPromiseProxy<firebase.messaging.Messaging>, 'deleteToken' | 'getToken' | 'requestPermission'> {\n}\n\n@Injectable({\n  providedIn: 'any'\n})\nexport class AngularFireMessaging {\n\n  public readonly requestPermission: Observable<void>;\n  public readonly getToken: Observable<string | null>;\n  public readonly tokenChanges: Observable<string | null>;\n  public readonly messages: Observable<{}>;\n  public readonly requestToken: Observable<string | null>;\n  public readonly deleteToken: (token: string) => Observable<boolean>;\n\n  constructor(\n    @Inject(FIREBASE_OPTIONS) options: FirebaseOptions,\n    @Optional() @Inject(FIREBASE_APP_NAME) nameOrConfig: string | FirebaseAppConfig | null | undefined,\n    // tslint:disable-next-line:ban-types\n    @Inject(PLATFORM_ID) platformId: Object,\n    zone: NgZone,\n    @Optional() @Inject(VAPID_KEY) vapidKey: string|null,\n    @Optional() @Inject(SERVICE_WORKER) _serviceWorker: any,\n  ) {\n    const schedulers = new ɵAngularFireSchedulers(zone);\n    const serviceWorker: Promise<ServiceWorkerRegistration> | null = _serviceWorker;\n\n    const messaging = of(undefined).pipe(\n      subscribeOn(schedulers.outsideAngular),\n      observeOn(schedulers.insideAngular),\n      switchMap(() => isPlatformServer(platformId) ? EMPTY : import('firebase/messaging')),\n      map(() => ɵfirebaseAppFactory(options, zone, nameOrConfig)),\n      switchMap(app => ɵfetchInstance(`${app.name}.messaging`, 'AngularFireMessaging', app, async () => {\n        const messaging = app.messaging();\n        if (firebaseLTv8) {\n          if (vapidKey) {\n            messaging.usePublicVapidKey(vapidKey);\n          }\n          if (serviceWorker) {\n            messaging.useServiceWorker(await serviceWorker);\n          }\n        }\n        return messaging;\n      }, [vapidKey, serviceWorker])),\n      shareReplay({ bufferSize: 1, refCount: false })\n    );\n\n    this.requestPermission = messaging.pipe(\n      subscribeOn(schedulers.outsideAngular),\n      observeOn(schedulers.insideAngular),\n      // tslint:disable-next-line\n      switchMap(messaging => firebase.messaging.isSupported() ? messaging.requestPermission() : throwError('Not supported.'))\n    );\n\n    this.getToken = messaging.pipe(\n      subscribeOn(schedulers.outsideAngular),\n      observeOn(schedulers.insideAngular),\n      switchMap(async messaging => {\n        if (firebase.messaging.isSupported() && Notification.permission === 'granted') {\n          if (firebaseLTv8) {\n            return await messaging.getToken();\n          } else {\n            const serviceWorkerRegistration = serviceWorker ? await serviceWorker : null;\n            return await messaging.getToken({ vapidKey, serviceWorkerRegistration });\n          }\n        } else {\n          return null;\n        }\n      })\n    );\n\n    const notificationPermission$ = new Observable<string>(emitter => {\n      navigator.permissions.query({ name: 'notifications' }).then(notificationPerm => {\n        notificationPerm.onchange = () => emitter.next();\n      });\n    });\n\n    const tokenChange$ = messaging.pipe(\n      subscribeOn(schedulers.outsideAngular),\n      observeOn(schedulers.insideAngular),\n      switchMapTo(notificationPermission$),\n      switchMapTo(this.getToken)\n    );\n\n    this.tokenChanges = messaging.pipe(\n      subscribeOn(schedulers.outsideAngular),\n      observeOn(schedulers.insideAngular),\n      switchMap(() => firebase.messaging.isSupported() ? concat(this.getToken, tokenChange$) : EMPTY)\n    );\n\n\n    this.messages = messaging.pipe(\n      subscribeOn(schedulers.outsideAngular),\n      observeOn(schedulers.insideAngular),\n      switchMap(messaging => firebase.messaging.isSupported() ? new Observable<string>(emitter =>\n        messaging.onMessage(next => emitter.next(next), err => emitter.error(err), () => emitter.complete())\n      ) : EMPTY),\n    );\n\n    this.requestToken = of(undefined).pipe(\n      subscribeOn(schedulers.outsideAngular),\n      observeOn(schedulers.insideAngular),\n      switchMap(() => this.requestPermission),\n      catchError(() => of(null)),\n      mergeMap(() => this.tokenChanges)\n    );\n\n    // SEMVER(7): drop token\n    this.deleteToken = (token?: string) => messaging.pipe(\n      subscribeOn(schedulers.outsideAngular),\n      observeOn(schedulers.insideAngular),\n      switchMap(messaging => messaging.deleteToken(token || undefined)),\n      defaultIfEmpty(false)\n    );\n\n    return ɵlazySDKProxy(this, messaging, zone);\n  }\n\n}\n\nɵapplyMixins(AngularFireMessaging, [proxyPolyfillCompat]);\n","import { NgModule } from '@angular/core';\nimport { AngularFireMessaging } from './messaging';\n\n@NgModule({\n  providers: [ AngularFireMessaging ]\n})\nexport class AngularFireMessagingModule { }\n"]}